name: Run UI Tests iOS

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - "**.md"
  pull_request:
    branches: [ "main" ]

env:
  # Release builds don't run on the Simulator
  BUILD_CONFIGURATION: Debug
  CSPROJ_TO_BUILD: samples/Plugin.Maui.UITestHelpers.Sample/Plugin.Maui.UITestHelpers.Sample.csproj
  APP_TO_TEST: samples/Plugin.Maui.UITestHelpers.Sample/bin/Debug/net8.0-ios/iossimulator-arm64/Plugin.Maui.UITestHelpers.Sample.app
  CSPROJ_TO_TEST: samples/UITests.iOS/UITests.iOS.csproj
  APP_ID: com.companyname.uitesthelperssample
  TARGET_FRAMEWORK: net8.0-ios
  XCODE_VERSION: 15.2
  TEST_SIM_NAME: UITestSim
  ARTIFACTS_PATH: ${{ github.workspace }}/output

jobs:
  ui-test-ios:

    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s '/Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer'

    - name: Prepare & Preboot iOS Simulator
      run: |
        simudid=$(xcrun simctl create ${{ env.TEST_SIM_NAME }} com.apple.CoreSimulator.SimDeviceType.iPhone-15-Pro com.apple.CoreSimulator.SimRuntime.iOS-17-2)
        echo "SIM_UDID=$(echo $simudid)" >> $GITHUB_ENV
        echo "Created Simulator UDID: $simudid"

        open -Fn "$(xcode-select -p)/Applications/Simulator.app"
        xcrun simctl bootstatus $simudid -b &

    - name: Restore Workload
      run: dotnet workload restore --project ${{ env.CSPROJ_TO_BUILD }}

    - name: Build iOS App
      run: dotnet build ${{ env.CSPROJ_TO_BUILD }} -f ${{ env.TARGET_FRAMEWORK }} -c ${{ env.BUILD_CONFIGURATION }}

    # - name: Install xharness
    #   run: |
    #     dotnet tool install Microsoft.DotNet.XHarness.CLI                                                   \
    #         --global                                                                                        \
    #         --add-source https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-eng/nuget/v3/index.json \
    #         --version "9.0.0-prerelease*"

    - name: Install Appium
      run: |
        npm install -g appium
        appium driver install xcuitest

    # - name: Run Appium Server
    #   run: |
    #     appium server --port=4723 --address=localhost --base-path="/wd/hub" --keep-alive-timeout 1200 --default-capabilities "{ \"newCommandTimeout\": \"9999999\" }" &

    - name: Install iOS App
      run: | 
        xcrun simctl install "${{ env.TEST_SIM_NAME }}" "${{ env.APP_TO_TEST }}"

    # - name: Install iOS App
    #   run: xharness apple install --app=${{ env.APP_TO_TEST }} --output-directory=${{ env.ARTIFACTS_PATH }}/xharness-logs --device="${{ env.SIM_UDID }}" --target=ios-simulator

    # - name: Open Simulator app
    #   run: |
    #     open -Fn "$(xcode-select -p)/Applications/Simulator.app"
    #     xcrun simctl bootstatus ${{ env.SIM_UDID }} -b

    - name: Run UI Tests iOS
      # We're passing on the values we used to create the Simulator with to the test project to find the correct one
      run: dotnet test ${{ env.CSPROJ_TO_TEST }} --environment SIMNAME="${{ env.TEST_SIM_NAME }}" --environment SIMID="${{ env.SIM_UDID }}" --environment APPIUM_LOG_FILE=${{ env.ARTIFACTS_PATH }}/appium-logs/appium.log

    - name: Publish Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: logs
        path: ${{ env.ARTIFACTS_PATH }}/**/*.*
